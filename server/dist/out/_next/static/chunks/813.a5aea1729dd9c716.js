(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[813],{16813:function(e,n,a){"use strict";a.r(n),a.d(n,{default:function(){return f}});var t=a(57437),o=a(2265),l=a(57818),c=a(91481),r=a(29820),i=a(22599);function s(e){let n=[],a=[],o={},l={},s=new Set,m=e.schema||[];if(void 0===m||0===m)return(0,t.jsx)("div",{children:"Schema has no tables"});let u=e=>e.table_schema+"."+e.table_name,h=e=>{let n=u(e);if(o.hasOwnProperty(n))return console.log("Table ".concat(e.table_schema," + ").concat(e.table_name," already exists.  You likely have duplicate tables")),o[n];let a=new c.DefaultNodeModel(e.table_name,"rgb(0,192,255)");return o[n]=a,e.columns.forEach(e=>{let t=a.addInPort(e.name),o=a.addOutPort(" ");l[n+"."+e.name]={inPort:t,outPort:o}}),a};var d=new c.DiagramEngine;d.installDefaultFactories();var _=new c.DiagramModel;for(let e of(n=m.map(e=>h(e)),m))for(let n of e.foreign_keys){let t=u(e),o=n.toTableSchema+"."+n.toTable,c=t+"."+n.fromColumn,r=o+"."+n.toColumn,i=l[c],m=l[r];if(!i){console.log("".concat(c," Column does not exist in schema.  The link from ").concat(c," to ").concat(r," will not be added"));continue}if(!m){console.log("".concat(r," Column does not exist in schema.  The link from ").concat(c," to ").concat(r," will not be added"));continue}if(s.has(c+r)){console.log("The link between ".concat(c," to ").concat(r," has already been added"));continue}s.add(c+r),s.add(r+c),a.push(i.outPort.link(m.inPort))}_.addAll(...n,...a);let f=function(e,n){var a,t;let o,l,s,m;let u=(a=n.serializeDiagram(),(l=(t=o=i.cloneDeep(a)).nodes.map(e=>{let n=e.ports.length?15*e.ports.length:0,a=e.ports.map(e=>e.label),t=[e.name,...a].reduce((e,n)=>e.length>n.length?e:n),o=t.length?10*t.length:0;return{id:e.id,metadata:{height:n<60?60:n,width:o<60?60:o,id:e.id}}}),s=t.links.map(e=>({from:e.source,to:e.target})).filter(e=>t.nodes.find(n=>n.id===e.from)&&t.nodes.find(n=>n.id===e.to)),(m=new r.graphlib.Graph).setGraph({}),m.setDefaultEdgeLabel(()=>({})),l.forEach(e=>{m.setNode(e.id,e.metadata)}),s.forEach(e=>{e.from&&e.to&&m.setEdge(e.from,e.to)}),r.layout(m),m.nodes().map(e=>m.node(e))).forEach(e=>{let n=o.nodes.find(n=>n.id===e.id);n.x=e.x-e.width/2,n.y=e.y-e.height/2}),o),h=new c.DiagramModel;return h.deSerializeDiagram(u,e),h}(d,_);return d.setDiagramModel(f),(0,t.jsx)(c.DiagramWidget,{allowLooseLinks:!1,allowCanvasTranslation:!0,allowCanvasZoom:!0,maxNumberPointsPerLink:0,smartRouting:!1,className:"srd-demo-canvas",diagramEngine:d})}a(86208);var m=(0,l.default)(()=>Promise.resolve(s),{ssr:!1}),u=a(29361);let h=(e,n)=>{let a={name:n,type:"integer"};return e&&(null==e?void 0:e.length)!==0?e.findIndex(e=>e.name===n)>=0?e:[...e,a]:[a]},d=e=>{let n=[];return e.forEach(e=>{let a=n.findIndex(n=>n.table_schema===e.table_schema&&n.table_name===e.table_name);if(a>=0){var t;let o={...n[a]};o={table_name:e.table_name,columns:h(null==o?void 0:o.columns,e.column_name),foreign_keys:[...null!==(t=null==o?void 0:o.foreign_keys)&&void 0!==t?t:[],{toTable:e.foreign_table_name,toTableSchema:e.foreign_table_schema,fromColumn:e.column_name,fromColumnType:"integer",toColumn:e.foreign_column_name,toColumnType:"integer"}],table_schema:e.table_schema},n[a]=o}else n.push({table_name:e.table_name,columns:[{name:e.column_name,type:"integer"}],foreign_keys:[{toTable:e.foreign_table_name,toTableSchema:e.foreign_table_schema,fromColumn:e.column_name,fromColumnType:"integer",toColumn:e.foreign_column_name,toColumnType:"integer"}],table_schema:e.table_schema})}),console.log(n),n},_=()=>{let[e,n]=(0,o.useState)(),a=new u.Z("PG");return(0,o.useEffect)(()=>{null==a||a.getErdData().then(e=>n(d(null==e?void 0:e.rows))).catch(console.error)},[]),e?(0,t.jsx)("div",{className:"h-full w-full",children:(0,t.jsx)(m,{schema:e})}):(0,t.jsx)("div",{className:"h-full w-full m-auto bg-gray-800 text-gray-400 flex justify-center items-center",children:(0,t.jsx)("span",{children:"Loading..."})})};var f=(0,l.default)(()=>Promise.resolve(_),{ssr:!1})},29361:function(e,n,a){"use strict";a.d(n,{Z:function(){return l}});let t=async(e,n)=>{let a=await fetch("http://localhost:3253/api/execute_pg",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({queries:e})});if(!a.ok)throw Error("Failed to execute query");return await a.json()};class o{constructor(e){this.executeSQL=e=>new Promise((n,a)=>{t([e],this.id).then(e=>{var t,o;(null==e?void 0:null===(t=e.data)||void 0===t?void 0:t[0])?n(null==e?void 0:null===(o=e.data)||void 0===o?void 0:o[0]):a(Error("Failed to execute query"))}).catch(a)}),this.getDBSchemas=()=>new Promise((e,n)=>{this.executeSQL("SELECT schema_name\n      FROM information_schema.schemata\n      WHERE \"schema_name\" NOT LIKE 'pg_%' AND schema_name <> 'information_schema';").then(a=>(null==a?void 0:a.rows)&&Array.isArray(null==a?void 0:a.rows)?e(null==a?void 0:a.rows.filter(e=>!!(null==e?void 0:e.schema_name)).map(e=>e.schema_name)):n(Error("Failed to parse the schemas"))).catch(n)}),this.getErdData=()=>new Promise((e,n)=>{this.executeSQL("SELECT\n      tc.table_schema,\n      tc.constraint_name,\n      tc.table_name,\n      kcu.column_name,\n      ccu.table_schema AS foreign_table_schema,\n      ccu.table_name AS foreign_table_name,\n      ccu.column_name AS foreign_column_name\n  FROM\n      information_schema.table_constraints AS tc\n      JOIN information_schema.key_column_usage AS kcu\n        ON tc.constraint_name = kcu.constraint_name\n        AND tc.table_schema = kcu.table_schema\n      JOIN information_schema.constraint_column_usage AS ccu\n        ON ccu.constraint_name = tc.constraint_name\n        AND ccu.table_schema = tc.table_schema;\n  ").then(n=>(console.log(n),e(n))).catch(n)}),this.getAllTables=e=>new Promise((n,a)=>{this.executeSQL("SELECT * FROM information_schema.tables\n      WHERE table_schema = '".concat(e,"'")).then(e=>(null==e?void 0:e.rows)&&Array.isArray(null==e?void 0:e.rows)?n(null==e?void 0:e.rows.filter(e=>!!(null==e?void 0:e.table_name))):a(Error("Failed to parse the schemas"))).catch(a)}),this.getTableData=e=>{let{schema:n,table:a,pagenumber:t=1,size:o=50,sortedColumns:l}=e;return new Promise((e,c)=>{let r='SELECT * FROM "'.concat(n,'"."').concat(a,'" ');l&&(r+=" ORDER BY "+Object.entries(l).map(e=>{let[n,a]=e;return"".concat(n," ").concat(a)}).join(",")),r+=" LIMIT ".concat(o," OFFSET ").concat((t-1)*o,";"),this.executeSQL(r).then(n=>e(n)).catch(c)})},this.getColumnNames=e=>{let{schema:n,table:a}=e;return new Promise((e,t)=>{let o="SELECT\n      column_name,\n      data_type\n    FROM\n      INFORMATION_SCHEMA.COLUMNS\n    WHERE\n      TABLE_NAME = '".concat(a,"'\n      AND table_schema = '").concat(n,"';");this.executeSQL(o).then(n=>e(n)).catch(t)})},this.id=e}}var l=o},86208:function(){}}]);